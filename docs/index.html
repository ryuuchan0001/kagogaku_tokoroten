<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>マイクで動く2Dアクション</title>
<style>
  canvas { background: #222; display: block; margin: 0 auto; }
</style>
</head>
<body>
<canvas id="game" width="800" height="400"></canvas>
<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let player = { x: 100, y: 300, vy: 0, onGround: true };
let micLevel = 0;

// 🎤 マイク入力の取得
async function setupMic() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const audioCtx = new AudioContext();
  const analyser = audioCtx.createAnalyser();
  const source = audioCtx.createMediaStreamSource(stream);
  source.connect(analyser);

  const data = new Uint8Array(analyser.fftSize);
  function getMicLevel() {
    analyser.getByteTimeDomainData(data);
    const rms = Math.sqrt(data.reduce((s, v) => s + (v - 128) ** 2, 0) / data.length);
    micLevel = rms;
    requestAnimationFrame(getMicLevel);
  }
  getMicLevel();
}

setupMic();

// 🕹️ ゲームループ
function loop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "white";
  ctx.fillRect(0, 380, 800, 20); // 地面
  ctx.fillStyle = "cyan";
  ctx.fillRect(player.x, player.y - 20, 20, 20);

  // 🎤 音量が一定以上ならジャンプ
  if (micLevel > 10 && player.onGround) {
    player.vy = -10;
    player.onGround = false;
  }

  // 重力処理
  player.vy += 0.5;
  player.y += player.vy;
  if (player.y >= 300) {
    player.y = 300;
    player.vy = 0;
    player.onGround = true;
  }

  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
